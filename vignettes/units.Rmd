<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Measurement Units of  Quantities for R Vectors}
-->

# Measurement Units of Quantities for R Vectors

R has little support for physical measurement units.  The exception
is formed by time differences: time differences objects of class
`difftime` have a `units` attribute that can be modified:

```{r}
t1 = Sys.time() 
t2 = t1 + 3600 
d = t2 - t1
class(d)
units(d)
d
units(d) = "secs"
d
```
We see here that the `units` method is used to set and modify the
unit of time difference. 

This idea can be generalized to other physical units. The
`units` package, presented here, does this, and builds upon the
[udunits2](https://cran.r-project.org/package=udunits2)
R package, which in turn is build upon the
[udunits2](https://www.unidata.ucar.edu/software/udunits/) C library.
The `udunits2` library provides the following operations:

* validating whether a string, such as `m/s` is a valid physical unit
* verifying whether two strings such as `m/s` and `km/h` are convertable
* converting values between two convertable units 
* providing names and symbols for specific units
* handle different character encodings (utf8, ascii, iso-8859-1 and latin1)

This R package, called `units`, uses R package udunits2 to extend
R with functionality for manipulating numeric vectors that have
physical measurement units associated with them, in a similar way as
`difftime` objects behave.

## Setting units, unit conversion

Units must be defined before they are used. Units are defined from a string but by explicitly defining units before they are used we avoid having new units in use due to misspellings. A unit is defined using the `make_units` function

```{r}
library(units)
m <- make_unit("m")
s <- make_unit("s")
```

and can then be used in expressions

```{r}
(a <- 1:10 * m/s)
```

Units from `udunits2` are defined in a list, `ud_units` and can be used either by attaching the list or using `with`. The latter is preferable since some unit names will conflict with function names, e.g. `min` for minuts and minimum.

```{r}
rm(m) ; rm(s)
with(ud_units, 1:10 * m/s)
```

When conversion is meaningful, such as hours to seconds or meters to kilometers, conversion can be done explicitly by setting the units of a vector
```{r}
b = a
units(b) <- with(ud_units, km/h)
b
```


## Basic manipulations

### Arithmetic operations

Arithmetic operations verify units, and create new ones
```{r}
a + a
a * a
a ^ 2.5
```
and convert if necessary:
```{r}
a + b # m/s + km/h -> m/s
```
but units are not simplified:
```{r}
t <- with(ud_units, s)
a * t
```

Allowed operations that require convertable units are `+`, `-`, `==`,
`!=`, `<`, `>`, `<=`, `>=`.  Operations that lead to new units are
`*`, `/`, and the power operations `**` and `^`.


### Mathematical functions

Mathematical operations allowed are: `abs`, `sign`, `floor`,
`ceiling`, `trunc`, `round`, `signif`, `log`, `cumsum`, `cummax`, `cummin`.
```{r}
signif(a ^ 2.5, 3)
cumsum(a)
log(a) # base defaults to exp(1)
log(a, base = 10)
log(a, base = 2)
```

### Summary functions
Summary functions `sum`, `min`, `max`, and `range` are allowed:
```{r}
sum(a)
min(a)
max(a)
range(a)
with(ud_units, min(m/s, km/h)) # converts to first unit:
```

### Printing
Following `difftime`, printing behaves differently for length-one vectors:
```{r}
a
a[1]
```

### Subsetting
The usual subsetting rules work:
```{r}
a[2:5]
a[-(1:9)]
```

### Concatenation
```{r}
c(a,a)
```
concatenation converts to the units of the first argument, if necessary:
```{r}
c(a,b) # m/s, km/h -> m/s
c(b,a) # km/h, m/s -> km/h
```

## Conversion to/from `difftime`
From `difftime` to `units`:
```{r}
t1 = Sys.time() 
t2 = t1 + 3600 
d = t2 - t1
du <- as.units(d)
```
vice versa:
```{r}
dt = as.dt(du)
class(dt)
dt
```

## units in `matrix` objects
```{r}
with(ud_units, matrix(1:4,2,2) * m/s)
with(ud_units, matrix(1:4,2,2) * m/s * 4 * m/s)
```
but
```{r}
with(ud_units, (matrix(1:4,2,2) * m/s) %*% (4:3 * m/s))
```
strips units.

## units objects in `data.frame`s

```{r}
set.seed(131)
d <- with(ud_units,
         data.frame(x = runif(4), 
                    y = runif(4) * s, 
                    z = 1:4 * m/s))
d
summary(d)
d$yz = with(d, y * z)
d
d[1, "yz"]
```
